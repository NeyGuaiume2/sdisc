{% extends 'base.html' %}

{% block title %}Seu Perfil DISC{% endblock %}

{% block content %}
<div class="container mt-5">
    <h1 class="mb-4 text-center">Seu Perfil DISC</h1>

    {# Bloco principal (sem alterações da versão anterior) #}
    {% if result and result.primary_type != '?' and result.secondary_type != '?' %}
        {% set scores_from_py = result.get_scores() %} {# Chama o método getter #}
        {% set detailed_report_data = result.get_detailed_report() %} {# Chama o método getter #}

        <div class="row mb-4">
            <!-- Coluna do Gráfico -->
            <div class="col-md-6 mb-4 mb-md-0">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        Gráfico do Perfil DISC
                    </div>
                    <div class="card-body d-flex flex-column justify-content-center align-items-center">
                         {# Container do Gráfico - AJUSTE DE ALTURA OPCIONAL #}
                        <div style="position: relative; width: 100%; max-width: 450px; margin: auto; height: 350px;"> {# Aumentei um pouco a altura para barras verticais ficarem melhores #}
                            <canvas id="discChart"></canvas> {# Mantido ID 'discChart' #}
                        </div>
                        <div id="chartFallback" class="text-center mt-3" style="display: none;">
                            {# Mensagem de fallback #}
                        </div>
                        <p class="text-muted small mt-2 text-center">Este gráfico representa a intensidade de cada fator DISC.</p>
                    </div>
                </div>
            </div>

            <!-- Coluna do Resumo (sem alterações da versão anterior) -->
            <div class="col-md-6">
                <div class="card shadow-sm h-100">
                    <div class="card-header">
                        Resumo do Perfil
                    </div>
                    <div class="card-body">
                        {% set primary_title = profile_interpretations.get(result.primary_type, {}).get('title', result.primary_type) %}
                        {% set secondary_title = profile_interpretations.get(result.secondary_type, {}).get('title', result.secondary_type) %}
                        <p><strong>Perfil Primário:</strong> {{ result.primary_type }} ({{ primary_title }})</p>
                        <p><strong>Perfil Secundário:</strong> {{ result.secondary_type }} ({{ secondary_title }})</p>
                        {% if not profile_interpretations %}<p class="text-danger small">Interpretações dos títulos não carregadas.</p>{% endif %}
                        <hr>
                        <p><strong>Níveis de Intensidade (Scores):</strong></p>
                        {% if scores_from_py %}
                        <ul>
                            <li><strong>D (Dominância):</strong> {{ scores_from_py.get('D', 'N/A') }}</li>
                            <li><strong>I (Influência):</strong> {{ scores_from_py.get('I', 'N/A') }}</li>
                            <li><strong>S (Estabilidade):</strong> {{ scores_from_py.get('S', 'N/A') }}</li>
                            <li><strong>C (Conformidade):</strong> {{ scores_from_py.get('C', 'N/A') }}</li>
                        </ul>
                        {% elif scores_from_py is none %}<p class="text-danger small">Erro ao carregar scores do banco de dados.</p>
                        {% else %}<p class="text-warning small">Scores não disponíveis ou inválidos.</p>{% endif %}
                        <hr>
                        <p class="small text-muted">Data da Avaliação (UTC):
                           {% if result.timestamp and hasattr(result.timestamp, 'strftime') %}
                             {{ result.timestamp.strftime('%d/%m/%Y %H:%M:%S') }}
                           {% else %} N/A {% endif %}
                         </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Seção de Interpretação Detalhada (sem alterações da versão anterior) -->
        {% if profile_interpretations and detailed_report_data %}
            {# (Conteúdo das abas e detalhes aqui - igual à versão anterior) #}
            <div class="card shadow-sm mb-4">
                <div class="card-header">Interpretação Detalhada</div>
                <div class="card-body">
                    <ul class="nav nav-tabs mb-3" id="discTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                           <button class="nav-link active" id="primary-tab" data-bs-toggle="tab" data-bs-target="#primary-content" type="button" role="tab" aria-controls="primary-content" aria-selected="true">
                               Perfil Primário: {{ primary_title }} ({{ result.primary_type }})
                           </button>
                       </li>
                       {% if result.primary_type != result.secondary_type %}
                       <li class="nav-item" role="presentation">
                           <button class="nav-link" id="secondary-tab" data-bs-toggle="tab" data-bs-target="#secondary-content" type="button" role="tab" aria-controls="secondary-content" aria-selected="false">
                               Influência Secundária: {{ secondary_title }} ({{ result.secondary_type }})
                           </button>
                       </li>
                       {% endif %}
                        <li class="nav-item" role="presentation">
                           <button class="nav-link" id="general-tab" data-bs-toggle="tab" data-bs-target="#general-content" type="button" role="tab" aria-controls="general-content" aria-selected="false">
                               Visão Geral
                           </button>
                       </li>
                    </ul>
                    <div class="tab-content" id="discTabsContent">
                        {# Macro para lista #}
                        {% macro render_list(items, default_message='Nenhuma informação disponível.') %}
                        <ul>
                            {% if items is iterable and items is not string and items %}
                                {% for item in items %} <li>{{ item }}</li> {% endfor %}
                            {% else %}
                                <li>{{ default_message }}</li>
                            {% endif %}
                        </ul>
                        {% endmacro %}

                        <!-- Conteúdo Primário -->
                        {% set primary_details = detailed_report_data.get('primary_profile_details', {}) %}
                        <div class="tab-pane fade show active" id="primary-content" role="tabpanel" aria-labelledby="primary-tab">
                            <h4>Perfil {{ primary_details.get('title', result.primary_type) }} ({{ result.primary_type }})</h4>
                            <p><strong>Descrição Geral:</strong> {{ primary_details.get('description', 'N/A') }}</p>
                            <p><strong>Motivação Principal:</strong> {{ primary_details.get('motivation', 'N/A') }}</p>
                            <h5>Características Comuns:</h5> {{ render_list(primary_details.get('characteristics')) }}
                            <h5>Pontos Fortes:</h5> {{ render_list(primary_details.get('strengths')) }}
                            <h5>Áreas de Desenvolvimento:</h5> {{ render_list(primary_details.get('weaknesses')) }}
                            <h5>Como se Relacionar (Dicas):</h5> {{ render_list(primary_details.get('how_to_work_with')) }}
                        </div>
                        <!-- Conteúdo Secundário -->
                        {% if result.primary_type != result.secondary_type %}
                            {% set secondary_details = detailed_report_data.get('secondary_profile_details', {}) %}
                            <div class="tab-pane fade" id="secondary-content" role="tabpanel" aria-labelledby="secondary-tab">
                                <h4>Influência do Perfil {{ secondary_details.get('title', result.secondary_type) }} ({{ result.secondary_type }})</h4>
                                <p>Seu perfil secundário adiciona nuances ao seu comportamento primário.</p>
                                <p><strong>Descrição Geral:</strong> {{ secondary_details.get('description', 'N/A') }}</p>
                                <p><strong>Motivação Principal:</strong> {{ secondary_details.get('motivation', 'N/A') }}</p>
                                <h5>Características Comuns:</h5> {{ render_list(secondary_details.get('characteristics')) }}
                                <h5>Pontos Fortes:</h5> {{ render_list(secondary_details.get('strengths')) }}
                                <h5>Áreas de Desenvolvimento:</h5> {{ render_list(secondary_details.get('weaknesses')) }}
                                <h5>Como se Relacionar (Dicas):</h5> {{ render_list(secondary_details.get('how_to_work_with')) }}
                           </div>
                        {% endif %}
                        <!-- Conteúdo Geral -->
                        <div class="tab-pane fade" id="general-content" role="tabpanel" aria-labelledby="general-tab">
                            <h4>Visão Geral do seu Perfil</h4>
                            {% if detailed_report_data.get('profile_summary') %}
                                <p>{{ detailed_report_data.profile_summary | replace('\n', '<br>') | safe }}</p>
                            {% else %}
                                <p>Combine as informações das abas anteriores para entender como seus traços interagem.</p>
                            {% endif %}
                            {% if detailed_report_data.get('development_areas_list') %}
                                <h5 class="mt-4">Sugestões Gerais para Desenvolvimento:</h5>
                                {{ render_list(detailed_report_data.development_areas_list) }}
                            {% endif %}
                            <p class="mt-4"><strong>Lembre-se:</strong> O perfil DISC é uma ferramenta [...]</p>
                       </div>
                   </div>
               </div>
           </div>
        {% elif not detailed_report_data and result %}
            <div class="alert alert-warning" role="alert">O resumo do perfil foi carregado, mas os detalhes não puderam ser extraídos.</div>
        {% elif not profile_interpretations %}
            <div class="alert alert-warning" role="alert">Informações de interpretação não puderam ser carregadas.</div>
        {% endif %}

        <!-- Botões de Ação (sem alterações) -->
        <div class="text-center mt-4 mb-5">
            <a href="{{ url_for('main.index') }}" class="btn btn-secondary">Voltar ao Início</a>
            <a href="{{ url_for('main.quiz') }}" class="btn btn-primary" id="new-assessment">Refazer Teste</a>
        </div>

    {% else %}
        {# Mensagem se não houver resultado válido (sem alterações) #}
        <div class="alert alert-warning text-center" role="alert">
            {% if result and (result.primary_type == '?' or result.secondary_type == '?') %}
                 Ocorreu um erro ao calcular ou salvar os resultados anteriores (ID: {{ result.id }}). Por favor, <a href="{{ url_for('main.quiz') }}" class="alert-link">refaça o teste</a>.
            {% elif not result %}
                 Nenhum resultado de avaliação encontrado na sessão. Por favor, <a href="{{ url_for('main.quiz') }}" class="alert-link">inicie o teste</a>.
            {% else %}
                 Não foi possível exibir os resultados. <a href="{{ url_for('main.quiz') }}" class="alert-link">Tente refazer o teste</a>.
            {% endif %}
        </div>
    {% endif %} {# Fim do if result and result.primary_type != '?' #}

</div>
{% endblock %}

{% block extra_js %}
<!-- Incluir Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const canvasElement = document.getElementById('discChart'); // Usa o ID correto do canvas
        const fallbackElement = document.getElementById('chartFallback');
        let chartInstance = null;

        // --- Lógica do Gráfico de Barras Verticais ---
        {% set scores_from_py = result.get_scores() if result else None %} // Pega os scores do objeto result, se ele existir

        const scoresData = {{ scores_from_py | tojson if scores_from_py is not none else 'null' }}; // Passa para JS (ou null se não houver scores)

        // Log para depuração no console do navegador
        console.log('Dados recebidos do backend para o gráfico:', scoresData);

        let scoresAreValid = false;
        let dScore, iScore, sScore, cScore;

        // Validação robusta dos dados no JS
        if (scoresData && typeof scoresData === 'object' &&
            scoresData.hasOwnProperty('D') && typeof scoresData.D === 'number' &&
            scoresData.hasOwnProperty('I') && typeof scoresData.I === 'number' &&
            scoresData.hasOwnProperty('S') && typeof scoresData.S === 'number' &&
            scoresData.hasOwnProperty('C') && typeof scoresData.C === 'number')
        {
            scoresAreValid = true;
            dScore = scoresData.D;
            iScore = scoresData.I;
            sScore = scoresData.S;
            cScore = scoresData.C;
            console.log("Validação JS passou. Scores numéricos:", { d: dScore, i: iScore, s: sScore, c: cScore });
        } else {
            console.warn("Validação JS FALHOU. Dados recebidos (scoresData) são inválidos ou ausentes:", scoresData);
        }

        if (scoresAreValid && canvasElement) {
            const ctx = canvasElement.getContext('2d');

            // Cores (iguais ao exemplo e versões anteriores)
            const discBackgroundColors = { D: 'rgba(239, 68, 68, 0.7)', I: 'rgba(250, 204, 21, 0.7)', S: 'rgba(34, 197, 94, 0.7)', C: 'rgba(59, 130, 246, 0.7)' };
            const discBorderColors = { D: 'rgb(239, 68, 68)', I: 'rgb(250, 204, 21)', S: 'rgb(34, 197, 94)', C: 'rgb(59, 130, 246)' };

            // Dados para o gráfico
            const actualScores = [dScore, iScore, sScore, cScore];

            // Cálculo dinâmico dos limites do eixo Y para acomodar negativos
            let minY = Math.min(...actualScores);
            let maxY = Math.max(...actualScores);
            const buffer = Math.max(2, Math.abs(maxY - minY) * 0.1); // Margem de 10% ou >= 2
            const suggestedMinY = Math.floor(Math.min(0, minY) - buffer); // Garante que o 0 e negativos fiquem visíveis
            const suggestedMaxY = Math.ceil(Math.max(0, maxY) + buffer); // Garante que positivos fiquem visíveis

            try {
                 chartInstance = new Chart(ctx, {
                    type: 'bar', // TIPO BARRA
                    data: {
                        labels: ['Dominância (D)', 'Influência (I)', 'Estabilidade (S)', 'Conformidade (C)'],
                        datasets: [{
                            label: 'Intensidade', // Legenda do dataset (aparece no tooltip)
                            data: actualScores,
                            backgroundColor: [discBackgroundColors.D, discBackgroundColors.I, discBackgroundColors.S, discBackgroundColors.C],
                            borderColor: [discBorderColors.D, discBorderColors.I, discBorderColors.S, discBorderColors.C],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        // indexAxis: 'x', // Eixo X para categorias (PADRÃO para 'bar', não precisa especificar) -> Barras Verticais
                        scales: {
                            // Eixo Y (Valores) - Configuração para barras verticais
                            y: {
                                beginAtZero: false, // IMPORTANTE para scores negativos
                                suggestedMin: suggestedMinY, // Usa limite calculado
                                suggestedMax: suggestedMaxY, // Usa limite calculado
                                grid: {
                                    display: true, // Mostrar linhas de grade horizontais
                                    color: 'rgba(0, 0, 0, 0.08)'
                                },
                                title: {
                                    display: true,
                                    text: 'Score' // Título do Eixo Y
                                }
                            },
                            // Eixo X (Categorias) - Configuração para barras verticais
                            x: {
                                grid: {
                                    display: false // Ocultar linhas de grade verticais
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: false // Ocultar legenda geral (cores bastam)
                            },
                            tooltip: {
                                enabled: true, // Habilitar tooltips
                                callbacks: { // Opcional: Formatar tooltip
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) { label += ': '; }
                                         if (context.parsed.y !== null) { label += context.parsed.y; }
                                         return label;
                                     }
                                 }
                             }
                        },
                        responsive: true,
                        maintainAspectRatio: false // Permite controlar altura via CSS no container
                    }
                });
                console.log("Gráfico de barras criado com sucesso.");
                if (fallbackElement) fallbackElement.style.display = 'none';

            } catch (error) { // Tratamento de erro (sem alterações)
                console.error("Erro ao criar o gráfico Chart.js:", error);
                if(fallbackElement) { fallbackElement.innerHTML = '<p class="text-danger text-center fw-bold">Erro ao renderizar o gráfico.</p>'; fallbackElement.style.display = 'block'; }
                if(canvasElement) canvasElement.style.display = 'none';
            }

        } else { // Fallback (sem alterações, já usa a mensagem correta)
             let fallbackMessage = '';
             if (!canvasElement) {
                 console.warn("Elemento canvas 'discChart' não encontrado no DOM.");
                 fallbackMessage = '<p class="text-warning text-center">Elemento do gráfico não encontrado na página.</p>';
             } else if (!scoresAreValid) {
                 console.warn("Gráfico não pode ser criado: scoresAreValid é false.");
                  fallbackMessage = '<p class="text-muted text-center">Gráfico indisponível. Os scores não puderam ser carregados ou são inválidos.</p>';
                 if(canvasElement) canvasElement.style.display = 'none';
             }
             if(fallbackElement && fallbackMessage) {
                 fallbackElement.innerHTML = fallbackMessage;
                 fallbackElement.style.display = 'block';
             }
        }
        // --- Fim da Lógica do Gráfico ---
    });
</script>
{% endblock %}